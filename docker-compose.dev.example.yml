# ---------------------------------------------------------------------------
# INSTRUCTIONS:
# 1. Copy this file to 'docker-compose.dev.yml' (which is git-ignored).
# 2. Ensure you have run 'gcloud auth application-default login'.
# 3. Mac/Linux: No edits needed.
# 4. Windows: Update the volume path to your local gcloud credentials.
# ---------------------------------------------------------------------------

services:
  # Backend API server (Dev Mode)
  backend:
    # 1. Load Environment Variables (DB_USER, PROJECT_NAME, etc.)
    # Ensure your .env file contains: DB_USER=your.email@gmail.com
    env_file:
      - .env

    # 2. Enable Hot-Reloading for Python
    command: python run_server.py --host 0.0.0.0 --reload

    # 3. Internal Credential Pointer
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/keys/adc.json

    volumes:
      # --- Authentication Mapping ---
      # This maps your host's 'gcloud login' credentials into the container.
      # MAC/LINUX: Works automatically with ${HOME}.
      # WINDOWS: Replace ${HOME} with the absolute path to your config folder
      #          (e.g., C:/Users/Name/AppData/Roaming/gcloud/...)
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/keys/adc.json:ro

      # --- Code Hot-Sync ---
      - ./src:/app/src
      - ./run_server.py:/app/run_server.py

  # Frontend Dev Server
  frontend-dev:
    image: oven/bun:latest
    working_dir: /app
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    # Install dependencies and start Vite dev server
    command: sh -c "bun install && bun run dev -- --host 0.0.0.0"
    environment:
      - VITE_API_URL=http://localhost:8000
    restart: unless-stopped
